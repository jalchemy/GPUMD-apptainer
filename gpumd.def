# This is a multi-stage Apptainer definition file that creates a minimal,
# self-contained GPUMD image. It builds GPUMD in a build stage and then 
# copies the binaries to a clean final stage.
Bootstrap: docker
From: nvidia/cuda:13.0.1-devel-ubuntu24.04
Stage: build

%arguments
    CUDA_SM_ARCH=89

%post
    # --- 1. Installation Phase ---
    export DEBIAN_FRONTEND=noninteractive
    # Check for cached binaries and libs
    if [ -f "/tmp/artifacts/gpumd" ] && [ -f "/tmp/artifacts/nep" ] && [ -d "/tmp/artifacts/libs" ]; then
        echo "--> Found cached binaries and libs. Skipping compilation."
        mkdir -p /usr/local/gpumd/src
        mkdir -p /usr/local/gpumd/libs
        cp /tmp/artifacts/gpumd /usr/local/gpumd/src/
        cp /tmp/artifacts/nep /usr/local/gpumd/src/
        cp -r /tmp/artifacts/libs/* /usr/local/gpumd/libs/
    else
        echo "--> No cached binaries found. Compiling from source."
        # Update apt and install build dependencies
        apt-get update && apt-get install -y --no-install-recommends \
            build-essential \
            wget \
            ca-certificates
            
        # Create a directory for the source code
        mkdir -p /usr/local/gpumd
        
        # Download and extract the GPUMD source code
        wget -O /tmp/gpumd.tar.gz https://github.com/brucefan1983/GPUMD/archive/refs/tags/v4.5.tar.gz
        tar -xzvf /tmp/gpumd.tar.gz -C /usr/local/gpumd --strip-components=1
        
        # Modify makefile to use custom CUDA architecture
        sed -i "s/CUDA_ARCH=-arch=sm_60/CUDA_ARCH=-arch=sm_{{ CUDA_SM_ARCH }}/g" /usr/local/gpumd/src/makefile
        sed -i 's/-std=c++14/-std=c++17/g' /usr/local/gpumd/src/makefile
        
        # Compile GPUMD
        cd /usr/local/gpumd/src
        make -j8
        # Identify and copy CUDA libraries, excluding system libraries
        mkdir -p /usr/local/gpumd/libs
        ldd gpumd | grep "=>" | awk '{print $3}' | grep -vE "^/lib|^/usr/lib" | xargs -I '{}' cp -L '{}' /usr/local/gpumd/libs/
        ldd nep | grep "=>" | awk '{print $3}' | grep -vE "^/lib|^/usr/lib" | xargs -I '{}' cp -L '{}' /usr/local/gpumd/libs/

        # Copy artifacts to host-mounted directory
        cp gpumd /tmp/artifacts/
        cp nep /tmp/artifacts/
        cp -r /usr/local/gpumd/libs /tmp/artifacts/
    fi

Bootstrap: docker
From: debian:13-slim

%files
    /artifacts/gpumd /usr/local/bin/
    /artifacts/nep /usr/local/bin/
    /artifacts/libs /usr/local/lib/gpumd

%environment
    # Add the GPUMD binaries to the path
    export PATH="/usr/local/bin:$PATH"
    # Add the GPUMD libraries to the library path
    export LD_LIBRARY_PATH="/usr/local/lib/gpumd:$LD_LIBRARY_PATH"

%help
    This is a minimal Apptainer image for the GPUMD software.
    It is built on debian:12-slim and contains the gpumd and nep binaries.